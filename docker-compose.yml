services:
  task-service:
    container_name: task-service
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped
    ports:
      - "8080:8080"
    healthcheck:
      # Simpler match to avoid YAML/Windows quoting issues
      test: ["CMD-SHELL", "wget -qO- http://localhost:8080/actuator/health | grep -q UP"]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 60s
    networks:
      - observability

  prometheus:
    image: prom/prometheus:v2.53.0
    container_name: prometheus
    restart: unless-stopped
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:9090/-/ready"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    depends_on:
      task-service:
        condition: service_healthy
    networks:
      - observability

  grafana:
    image: grafana/grafana:10.4.6
    container_name: grafana
    restart: unless-stopped
    ports:
      - "3000:3000"
    volumes:
      - ./grafana/provisioning/datasources:/etc/grafana/provisioning/datasources
      - ./grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards
      - ./grafana/dashboards:/var/lib/grafana/dashboards
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:3000/login"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    depends_on:
      prometheus:
        condition: service_healthy
    networks:
      - observability

  jaeger:
    image: jaegertracing/all-in-one:1.74.0
    container_name: jaeger
    restart: unless-stopped
    ports:
      - "16686:16686"   # Jaeger UI
      - "4317:4317"     # OTLP gRPC
      - "4318:4318"     # OTLP HTTP
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:16686"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - observability

networks:
  observability:
    driver: bridge
